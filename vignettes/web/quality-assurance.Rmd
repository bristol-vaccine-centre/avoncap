---
title: "Quality assurance"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quality assurance}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(avoncap)
```

```{r setup}

if (!rlang::is_installed("avoncap")) devtools::load_all()

# The data input directory on my development machine:
options("avoncap.input" = "~/Data/avoncap/")

# library(avoncap)
devtools::load_all()

```

# loading and normalising the central database

```{r}
rawData2 = avoncap::load_data("avoncap-export","central", merge=TRUE)
# without merge: currently: INCONSISTENT COLUMN(S) IN FILES: sars_cov2_antigen
# due to the fact it is mostly a numeric but some values ">250"

# devtools::load_all()
normData2 = rawData2 %>% avoncap::validate_data() %>% avoncap::normalise_data()
failures = normData2 %>% avoncap::write_issues("~/avoncap-issues")
```

```{r}
tmp = failures %>% 
    filter(.error_type %in% c("none checked in checkbox","missing value")) %>% 
    inner_join(rawData2, by="record_number", suffix=c("",".raw")) %>%
    group_by(.variable) %>%
    filter(
      !is.na(enrollment_date) &
      !is.na(hosp)
    ) %>%
    filter(
      n()>20
    )
  
ggplot(tmp, aes(x=enrollment_date, fill=as.factor(hosp)))+
  geom_histogram(binwidth = 7)+
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y")+
  theme(axis.text.x.bottom = element_text(angle = 90, vjust=0.5, hjust=1))+
  facet_wrap(~.variable,scales = "free_y")

```


```{r}

normData2 = rawData2 %>% 
  avoncap::normalise_data(.nocache = TRUE)

augData2 = normData2 %>% avoncap::augment_data(.nocache = TRUE)
avoncap::find_new_field_names(normData2, "adm_diagnosis")

```
